<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전기차 충전 요금 계산기</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Noto Sans KR as the primary font */
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
        /* Simple scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Custom class for hiding elements */
        .hidden {
            display: none;
        }
        /* Styling for the share notification */
        #share-notification {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl mb-16">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">전기차 최저 충전 요금 계산기</h1>
            <p class="text-gray-600 mt-2">보유하신 멤버십 카드를 선택하고 충전기와 충전 속도를 입력하여 가장 저렴한 요금을 찾아보세요.</p>
        </header>

        <main class="bg-white p-6 md:p-8 rounded-2xl shadow-lg space-y-8">
            <!-- Loading State -->
            <div id="loader" class="text-center text-gray-500">
                <p>요금 데이터를 불러오는 중입니다...</p>
            </div>

            <!-- Main Content - Hidden until data is loaded -->
            <div id="main-content" class="hidden">
                <!-- Section 1: Membership Selection (Dropdown) -->
                <section>
                    <h2 class="text-xl font-semibold mb-4">1. 보유 멤버십 선택</h2>
                    <div class="relative" id="membership-multiselect">
                        <button id="membership-select-button" type="button" class="relative w-full cursor-default rounded-md bg-white py-3 pl-3 pr-10 text-left text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-600 sm:text-sm sm:leading-6">
                            <span class="block truncate">멤버십을 선택하세요</span>
                            <span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2">
                                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.53.22l3.5 3.5a.75.75 0 01-1.06 1.06L10 4.81 6.53 8.28a.75.75 0 01-1.06-1.06l3.5-3.5A.75.75 0 0110 3z" clip-rule="evenodd" /></svg>
                            </span>
                        </button>
                        <div id="membership-dropdown-panel" class="absolute z-10 mt-1 w-full max-h-60 overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none sm:text-sm hidden">
                            <div class="p-2">
                                <input type="text" id="membership-search" placeholder="멤버십 검색..." class="w-full p-2 border border-gray-300 rounded-md">
                                <div class="flex items-center my-2">
                                    <input type="checkbox" id="select-all-memberships" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                    <label for="select-all-memberships" class="ml-2 block text-sm font-medium text-gray-700">전체 선택</label>
                                </div>
                            </div>
                            <div id="memberships-container" class="divide-y divide-gray-200">
                                <!-- Membership checkboxes will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Charging Provider and Speed -->
                <section>
                    <h2 class="text-xl font-semibold mb-4">2. 충전 정보 입력</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Searchable Dropdown for Charging Provider -->
                        <div class="relative">
                            <label for="provider-search" class="block text-md font-medium text-gray-700 mb-1">충전 사업자</label>
                            <input type="text" id="provider-search" placeholder="충전 사업자 검색..." class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <div id="provider-dropdown" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto hidden">
                                <!-- Provider options will be dynamically inserted here -->
                            </div>
                            <input type="hidden" id="selected-provider">
                        </div>
                        <!-- Charging Speed Input -->
                        <div>
                            <label for="charging-speed" class="block text-md font-medium text-gray-700 mb-1">충전 속도 (kW)</label>
                            <input type="number" id="charging-speed" placeholder="예: 50" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>
                </section>

                <!-- Section 3: Options -->
                <section>
                    <h2 class="text-xl font-semibold mb-4">3. 추가 옵션</h2>
                    <div class="flex items-center">
                        <input type="checkbox" id="ignore-zero" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <label for="ignore-zero" class="ml-3 block text-md font-medium text-gray-700">0원 요금 제외 (무료 충전 제외)</label>
                    </div>
                </section>
            </div>
        </main>

        <!-- Result Section -->
        <section id="result-section" class="mt-8 bg-white p-6 md:p-8 rounded-2xl shadow-lg hidden">
             <h2 class="text-2xl font-bold text-center mb-4">계산 결과</h2>
             <div id="result" class="text-center p-6 rounded-lg bg-indigo-50 mb-4">
                 <p class="text-lg text-gray-600">입력값을 변경하여 최저 요금을 확인하세요.</p>
             </div>
             <div class="text-center">
                <button id="share-button" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">결과 공유하기</button>
             </div>
        </section>
    </div>
    
    <!-- Share Notification -->
    <div id="share-notification" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        링크가 복사되었습니다!
    </div>


    <script>
        // Data URL
        const DATA_URL = 'https://bunnyreview.b-cdn.net/sample.json';
        let chargingData = {};
        let allProviders = new Set();
        const LOCAL_STORAGE_KEY = 'evChargerInputs';

        // DOM Elements
        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');
        const resultSection = document.getElementById('result-section');
        const selectAllCheckbox = document.getElementById('select-all-memberships');
        const providerSearchInput = document.getElementById('provider-search');
        const providerDropdown = document.getElementById('provider-dropdown');
        const selectedProviderInput = document.getElementById('selected-provider');
        const chargingSpeedInput = document.getElementById('charging-speed');
        const ignoreZeroCheckbox = document.getElementById('ignore-zero');
        const resultDiv = document.getElementById('result');
        const shareButton = document.getElementById('share-button');
        const shareNotification = document.getElementById('share-notification');
        
        // Membership Dropdown Elements
        const membershipMultiselect = document.getElementById('membership-multiselect');
        const membershipSelectButton = document.getElementById('membership-select-button');
        const membershipDropdownPanel = document.getElementById('membership-dropdown-panel');
        const membershipSearchInput = document.getElementById('membership-search');
        const membershipsContainer = document.getElementById('memberships-container');


        /**
         * Fetches and processes the charging data from the URL.
         */
        async function loadData() {
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                chargingData = await response.json();
                
                populateMemberships();
                populateProviders();
                
                loader.classList.add('hidden');
                mainContent.classList.remove('hidden');
                resultSection.classList.remove('hidden');
                
                applyInitialState();
            } catch (error) {
                loader.textContent = '데이터를 불러오는 데 실패했습니다. 페이지를 새로고침 해주세요.';
                console.error("Failed to load charging data:", error);
            }
        }

        /**
         * Populates membership checkboxes in the multi-select dropdown.
         */
        function populateMemberships(filter = '') {
            const membershipNames = Object.keys(chargingData).sort();
            const selectedMemberships = getSelectedMemberships();
            membershipsContainer.innerHTML = '';
            
            membershipNames
                .filter(name => name.toLowerCase().includes(filter.toLowerCase()))
                .forEach(name => {
                    const isChecked = selectedMemberships.includes(name);
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-2 hover:bg-gray-100';
                    div.innerHTML = `
                        <input type="checkbox" id="mem-${name}" name="membership" value="${name}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isChecked ? 'checked' : ''}>
                        <label for="mem-${name}" class="ml-3 text-sm text-gray-600 w-full cursor-pointer">${name}</label>
                    `;
                    membershipsContainer.appendChild(div);
                });
        }

        /**
         * Extracts all unique provider names and populates the dropdown.
         */
        function populateProviders() {
            allProviders.clear();
            Object.values(chargingData).forEach(memberProviders => {
                Object.keys(memberProviders).forEach(provider => allProviders.add(provider));
            });
            renderProviderDropdown(Array.from(allProviders).sort());
        }

        /**
         * Renders the provider options in the dropdown.
         */
        function renderProviderDropdown(providers) {
            providerDropdown.innerHTML = '';
            if (providers.length === 0) {
                providerDropdown.innerHTML = `<div class="p-3 text-gray-500">검색 결과가 없습니다.</div>`;
                return;
            }
            providers.forEach(provider => {
                const optionDiv = document.createElement('div');
                optionDiv.textContent = provider;
                optionDiv.className = 'p-3 hover:bg-indigo-100 cursor-pointer';
                optionDiv.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    providerSearchInput.value = provider;
                    selectedProviderInput.value = provider;
                    providerDropdown.classList.add('hidden');
                    saveAndCalculate();
                });
                providerDropdown.appendChild(optionDiv);
            });
        }
        
        /**
         * Gets the currently selected memberships.
         */
        function getSelectedMemberships() {
            return Array.from(document.querySelectorAll('input[name="membership"]:checked')).map(cb => cb.value);
        }

        /**
         * Updates the text of the membership selection button.
         */
        function updateMembershipButtonText() {
            const selectedCount = getSelectedMemberships().length;
            const buttonTextSpan = membershipSelectButton.querySelector('span');
            if (selectedCount === 0) {
                buttonTextSpan.textContent = '멤버십을 선택하세요';
            } else if (selectedCount === document.querySelectorAll('input[name="membership"]').length) {
                buttonTextSpan.textContent = '모든 멤버십 선택됨';
            } else {
                buttonTextSpan.textContent = `${selectedCount}개 멤버십 선택됨`;
            }
        }
        
        /**
         * Saves current inputs and recalculates the cheapest rate.
         */
        function saveAndCalculate() {
            saveStateToLocalStorage();
            calculateCheapest();
        }

        /**
         * The core function to calculate the cheapest rate based on user inputs.
         */
        function calculateCheapest() {
            const selectedMemberships = getSelectedMemberships();
            const provider = selectedProviderInput.value;
            const speed = parseFloat(chargingSpeedInput.value);
            const ignoreZero = ignoreZeroCheckbox.checked;

            if (selectedMemberships.length === 0 || !provider || isNaN(speed) || speed <= 0) {
                let message = '입력값을 변경하여 최저 요금을 확인하세요.';
                if (selectedMemberships.length === 0) message = '하나 이상의 멤버십을 선택해주세요.';
                else if (!provider) message = '충전 사업자를 선택해주세요.';
                else if (isNaN(speed) || speed <= 0) message = '유효한 충전 속도를 입력해주세요.';
                resultDiv.innerHTML = `<p class="text-lg text-gray-600">${message}</p>`;
                return;
            }

            let cheapestPrice = Infinity;
            let cheapestProviders = [];

            selectedMemberships.forEach(membership => {
                const providerRates = chargingData[membership]?.[provider];
                if (providerRates) {
                    for (const rate of providerRates) {
                        if (speed >= rate.min_kW && speed <= rate.max_kW) {
                            if (ignoreZero && rate.price === 0) continue;
                            if (rate.price < cheapestPrice) {
                                cheapestPrice = rate.price;
                                cheapestProviders = [membership];
                            } else if (rate.price === cheapestPrice && !cheapestProviders.includes(membership)) {
                                cheapestProviders.push(membership);
                            }
                            break;
                        }
                    }
                }
            });

            if (cheapestProviders.length === 0) {
                resultDiv.innerHTML = `<p class="text-lg font-semibold text-red-600">해당 조건에 맞는 요금 정보를 찾을 수 없습니다.</p><p class="text-sm text-gray-500 mt-1">다른 충전 사업자나 속도를 시도해보세요.</p>`;
            } else {
                const providerList = cheapestProviders.join(', ');
                const label = cheapestProviders.length > 1 ? '가장 저렴한 멤버십' : '가장 저렴한 멤버십';
                resultDiv.innerHTML = `
                    <p class="text-gray-600 mb-1">${label}</p>
                    <p class="text-3xl font-bold text-indigo-600">${providerList}</p>
                    <p class="text-4xl font-bold text-gray-900 mt-4">${cheapestPrice.toLocaleString()} <span class="text-2xl font-medium text-gray-500">원/kWh</span></p>
                `;
            }
        }

        /**
         * Saves the current state of inputs to localStorage.
         */
        function saveStateToLocalStorage() {
            const state = {
                memberships: getSelectedMemberships(),
                provider: selectedProviderInput.value,
                speed: chargingSpeedInput.value,
                ignoreZero: ignoreZeroCheckbox.checked,
            };
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state));
        }

        /**
         * Applies initial state from URL parameters or localStorage.
         */
        function applyInitialState() {
            const urlParams = new URLSearchParams(window.location.search);
            let state;

            if (urlParams.has('m')) { // Check for shareable URL params
                state = {
                    memberships: urlParams.get('m') ? urlParams.get('m').split(',') : [],
                    provider: urlParams.get('p') || '',
                    speed: urlParams.get('s') || '',
                    ignoreZero: urlParams.get('iz') === 'true',
                };
            } else { // Fallback to localStorage
                const savedState = localStorage.getItem(LOCAL_STORAGE_KEY);
                state = savedState ? JSON.parse(savedState) : {};
            }

            // Apply state to inputs
            if (state.memberships && state.memberships.length > 0) {
                document.querySelectorAll('input[name="membership"]').forEach(cb => {
                    cb.checked = state.memberships.includes(cb.value);
                });
            }
            if (state.provider) {
                providerSearchInput.value = state.provider;
                selectedProviderInput.value = state.provider;
            }
            if (state.speed) {
                chargingSpeedInput.value = state.speed;
            }
            ignoreZeroCheckbox.checked = state.ignoreZero || false;

            updateMembershipButtonText();
            calculateCheapest();
        }

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', loadData);

        selectAllCheckbox.addEventListener('change', (e) => {
            membershipsContainer.querySelectorAll('input[name="membership"]').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateMembershipButtonText();
            saveAndCalculate();
        });

        membershipsContainer.addEventListener('change', (e) => {
            if (e.target.name === 'membership') {
                if (!e.target.checked) selectAllCheckbox.checked = false;
                updateMembershipButtonText();
                saveAndCalculate();
            }
        });

        // Membership dropdown interactions
        membershipSelectButton.addEventListener('click', () => {
            membershipDropdownPanel.classList.toggle('hidden');
        });
        
        membershipSearchInput.addEventListener('input', (e) => {
            populateMemberships(e.target.value);
        });

        document.addEventListener('click', (e) => {
            if (!membershipMultiselect.contains(e.target)) {
                membershipDropdownPanel.classList.add('hidden');
            }
            if (!providerSearchInput.parentElement.contains(e.target)) {
                providerDropdown.classList.add('hidden');
            }
        });
        
        // Provider dropdown interactions
        providerSearchInput.addEventListener('focus', () => {
             renderProviderDropdown(Array.from(allProviders).sort());
             providerDropdown.classList.remove('hidden');
        });

        providerSearchInput.addEventListener('input', () => {
            const searchTerm = providerSearchInput.value.toLowerCase();
            const filteredProviders = Array.from(allProviders).filter(p => p.toLowerCase().includes(searchTerm)).sort();
            renderProviderDropdown(filteredProviders);
            providerDropdown.classList.remove('hidden');
            if (selectedProviderInput.value !== providerSearchInput.value) {
                 selectedProviderInput.value = '';
            }
        });

        chargingSpeedInput.addEventListener('input', saveAndCalculate);
        ignoreZeroCheckbox.addEventListener('change', saveAndCalculate);

        // Share button functionality
        shareButton.addEventListener('click', () => {
            const state = {
                memberships: getSelectedMemberships(),
                provider: selectedProviderInput.value,
                speed: chargingSpeedInput.value,
                ignoreZero: ignoreZeroCheckbox.checked,
            };
            
            const params = new URLSearchParams();
            if (state.memberships.length > 0) params.set('m', state.memberships.join(','));
            if (state.provider) params.set('p', state.provider);
            if (state.speed) params.set('s', state.speed);
            if (state.ignoreZero) params.set('iz', 'true');

            const shareUrl = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
            
            // Copy to clipboard
            const textarea = document.createElement('textarea');
            textarea.value = shareUrl;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            // Show notification
            shareNotification.classList.remove('opacity-0', 'translate-y-2');
            setTimeout(() => {
                shareNotification.classList.add('opacity-0', 'translate-y-2');
            }, 2000);
        });

    </script>
</body>
</html>
